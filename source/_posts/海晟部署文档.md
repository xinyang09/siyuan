---
title: 海晟部署文档
date: '2025-12-08 17:04:49'
updated: '2025-12-15 16:39:05'
permalink: /post/haisheng-deployment-document-zodip5.html
comments: true
toc: true
---



# 海晟部署文档

部署文件

/home/crea/deploy/新建目录

‍

‍

部署机（生产、测试）：10.154.13.132

测试root密码：Awdsm$525%

生产root密码：Awdsm$524%

‍

生产使用10.154.11.247作为部署机 

‍

‍

NAS为生产环境 挂载到节点/cpfs目录

‍

生产环境

```yaml
gitlab: yth.zjtobacco.com/das/gitlab
root/Unicdata@1qaz
nacos: 10.154.11.248/nacos
naocs/Unicdata@1qaz
```

```yaml
/home/crea/deploy/20251212-unic/openpai/images/updata-img.sh 

/cpfs/deploy/openpai
```

‍

‍

部署限制

```yaml
生产： 10.154.11.245  10.154.11.247
测试： 10.154.13.132  10.154.13.131

gitlab：131
app：131
dataset：131


model：139
```

‍

win电脑密码：2468013579

‍

```yaml
docker pull 192.168.2.56:32002/openpai/pai-b-api:20251212120228
docker pull 192.168.2.56:32002/openpai/pai-b-app:20251211114749
docker pull 192.168.2.56:32002/openpai/pai-b-dataset:20251211034757
docker pull 192.168.2.56:32002/openpai/pai-b-gateway:20251211114455
docker pull 192.168.2.56:32002/openpai/pai-b-model:20251211052508
docker pull 192.168.2.50:9443/aiplatform/docker:24.0.7-dind
docker pull 192.168.2.56:32002/openpai/pai-b-model:20251211034246
docker pull 192.168.2.50:9443/sso/backend-sso:20251211035735
docker pull 192.168.2.56:32002/openpai/geely-pai-b-system:20251119101145


docker tag 192.168.2.56:32002/openpai/pai-b-api:20251212120228 cr.registry.ext.yun.zjtobacco.com/szhyfyy-dev/pai-b-api:20251212120228
docker tag 192.168.2.56:32002/openpai/pai-b-app:20251211114749 cr.registry.ext.yun.zjtobacco.com/szhyfyy-dev/pai-b-app:20251211114749
docker tag 192.168.2.56:32002/openpai/pai-b-dataset:20251211034757 cr.registry.ext.yun.zjtobacco.com/szhyfyy-dev/pai-b-dataset:20251211034757
docker tag 192.168.2.56:32002/openpai/pai-b-gateway:20251211114455 cr.registry.ext.yun.zjtobacco.com/szhyfyy-dev/pai-b-gateway:20251211114455 
docker tag 192.168.2.56:32002/openpai/pai-b-model:20251211052508 cr.registry.ext.yun.zjtobacco.com/szhyfyy-dev/pai-b-model:20251211052508 
docker tag 192.168.2.50:9443/aiplatform/docker:24.0.7-dind cr.registry.ext.yun.zjtobacco.com/szhyfyy-dev/docker:24.0.7-dind 
docker tag 192.168.2.50:9443/sso/backend-sso:20251211035735 cr.registry.ext.yun.zjtobacco.com/szhyfyy-dev/pai-b-sso:20251211035735
docker tag 192.168.2.56:32002/openpai/geely-pai-b-system:20251119101145 cr.registry.ext.yun.zjtobacco.com/szhyfyy-dev/pai-b-system:20251119101145

docker save cr.registry.ext.yun.zjtobacco.com/szhyfyy-dev/pai-b-api:20251212120228 cr.registry.ext.yun.zjtobacco.com/szhyfyy-dev/pai-b-app:20251211114749 cr.registry.ext.yun.zjtobacco.com/szhyfyy-dev/pai-b-dataset:20251211034757 cr.registry.ext.yun.zjtobacco.com/szhyfyy-dev/pai-b-gateway:20251211114455 cr.registry.ext.yun.zjtobacco.com/szhyfyy-dev/pai-b-model:20251211052508 cr.registry.ext.yun.zjtobacco.com/szhyfyy-dev/docker:24.0.7-dind cr.registry.ext.yun.zjtobacco.com/szhyfyy-dev/pai-b-model:20251211034246 cr.registry.ext.yun.zjtobacco.com/szhyfyy-dev/pai-b-sso:20251211035735 cr.registry.ext.yun.zjtobacco.com/szhyfyy-dev/pai-b-system:20251119101145 -o unic-img.tar.gz

docker save cr.registry.ext.yun.zjtobacco.com/szhyfyy-dev/redis:7.0.7 cr.registry.ext.yun.zjtobacco.com/szhyfyy-dev/mysql:8.0

docker save 


docker save cr.registry.ext.yun.zjtobacco.com/szhyfyy-dev/pai-b-api:20251212120228 -o pai-b-api.tar.gz
docker save cr.registry.ext.yun.zjtobacco.com/szhyfyy-dev/pai-b-app:20251211114749 -o pai-b-app.tar.gz
docker save cr.registry.ext.yun.zjtobacco.com/szhyfyy-dev/pai-b-dataset:20251211034757 -o pai-b-dataset.tar.gz
docker save cr.registry.ext.yun.zjtobacco.com/szhyfyy-dev/pai-b-gateway:20251211114455 -o pai-b-gateway.tar.gz
docker save cr.registry.ext.yun.zjtobacco.com/szhyfyy-dev/pai-b-model:20251211052508 -o pai-b-model.tar.gz
docker save cr.registry.ext.yun.zjtobacco.com/szhyfyy-dev/docker:24.0.7-dind -o pai-b-docker.tar.gz
docker save cr.registry.ext.yun.zjtobacco.com/szhyfyy-dev/pai-b-sso:20251211035735 -o pai-b-sso.tar.gz
docker save cr.registry.ext.yun.zjtobacco.com/szhyfyy-dev/pai-b-system:20251119101145 -o pai-b-system.tar.gz
```

‍

GitLAB部署

上传镜像到镜像仓库

```yaml
docker laod -i gitlab-img.tar

docker tag 192.168.2.56:32002/gitlab/redis:6 cr.registry.ext.yun.zjtobacco.com/szhyfyy-dev/gitlab-redis:6
docker tag 192.168.2.56:32002/gitlab/postgres:16 cr.registry.ext.yun.zjtobacco.com/szhyfyy-dev/gitlab-postgres:16
docker tag 192.168.2.56:32002/gitlab/busybox:1.35.0 cr.registry.ext.yun.zjtobacco.com/szhyfyy-dev/busybox:1.35.0
docker tag 192.168.2.56:32002/gitlab/gitlab:latest cr.registry.ext.yun.zjtobacco.com/szhyfyy-dev/gitlab:v18.6
```

修改gitlab.yaml文件

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
    labels:
        name: gitlab
    name: gitlab
    namespace: openpai
spec:
    selector:
        matchLabels:
            name: gitlab
    template:
        metadata:
            labels:
                name: gitlab
            name: gitlab
        spec:
            containers:
                - env:
                    - name: TZ
                      value: Asia/Shanghai
                    - name: GITLAB_TIMEZONE
                      value: Beijing
                    - name: GITLAB_SECRETS_DB_KEY_BASE
                      value: long-and-random-alpha-numeric-string
                    - name: GITLAB_SECRETS_SECRET_KEY_BASE
                      value: long-and-random-alpha-numeric-string
                    - name: GITLAB_SECRETS_OTP_KEY_BASE
                      value: long-and-random-alpha-numeric-string
                    - name: GITLAB_ROOT_PASSWORD
                      value: Unicdata@1qaz
                    - name: GITLAB_ROOT_EMAIL
                      value: 517554016@qq.com
                    - name: GITLAB_HOST
                      value: git.k8s.local
                    - name: GITLAB_PORT
                      value: "80"
                    - name: GITLAB_NOTIFY_ON_BROKEN_BUILDS
                      value: "true"
                    - name: GITLAB_NOTIFY_PUSHER
                      value: "false"
                    - name: GITLAB_BACKUP_SCHEDULE
                      value: daily
                    - name: GITLAB_BACKUP_TIME
                      value: "01:00"
                    - name: DB_TYPE
                      value: postgres
                    - name: DB_HOST
                      value: postgresql
                    - name: DB_PORT
                      value: "5432"
                    - name: DB_USER
                      value: gitlab
                    - name: DB_PASS
                      value: Unicdata@1qaz
                    - name: DB_NAME
                      value: gitlab_production
                    - name: REDIS_HOST
                      value: redis
                    - name: REDIS_PORT
                      value: "6379"
                  image: 192.168.2.56:32002/openpai/gitlab
                  imagePullPolicy: IfNotPresent
                  name: gitlab
                  ports:
                    - containerPort: 80
                      name: http
                    - containerPort: 22
                      name: ssh
                  readinessProbe:
                    httpGet:
                        path: /
                        port: 80
                    initialDelaySeconds: 60
                    timeoutSeconds: 1
                  volumeMounts:
                    - mountPath: /home/git/data
                      name: data
                      subPath: gitlab
            initContainers:
                - command:
                    - sh
                    - -c
                    - chown -R 1000:1000 /home/git/data
                  image: 192.168.2.56:32002/openpai/busybox:1.35.0
                  name: fix-permissions
                  securityContext:
                    privileged: true
                  volumeMounts:
                    - mountPath: /home/git/data
                      name: data
                      subPath: gitlab
            volumes:
                - hostPath:
                    path: /data//gitlab-latest # 修改此行为实际hostPath地址
                  name: data
---
apiVersion: v1
kind: Service
metadata:
    labels:
        name: gitlab
    name: gitlab
    namespace: openpai
spec:
    ports:
        - name: http
          port: 80
          targetPort: http
    selector:
        name: gitlab

```

修改postgresql.yaml文件

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
    labels:
        name: postgresql
    name: postgresql
    namespace: openpai
spec:
    selector:
        matchLabels:
            name: postgresql
    template:
        metadata:
            labels:
                name: postgresql
            name: postgresql
        spec:
            containers:
                - env:
                    - name: POSTGRES_USER
                      value: gitlab
                    - name: POSTGRES_PASSWORD
                      value: Unicdata@1qaz
                    - name: POSTGRES_DB
                      value: gitlab_production
                    - name: DB_EXTENSION
                      value: pg_trgm,btree_gist
                    - name: USERMAP_UID
                      value: "999"
                    - name: USERMAP_GID
                      value: "999"
                  image: 192.168.2.56:32002/openpai/postgres:16
                  imagePullPolicy: IfNotPresent
                  name: postgresql
                  ports:
                    - containerPort: 5432
                      name: postgres
                  readinessProbe:
                    exec:
                        command:
                            - pg_isready
                            - -h
                            - localhost
                            - -U
                            - postgres
                    initialDelaySeconds: 30
                    timeoutSeconds: 1
                  volumeMounts:
                    - mountPath: /var/lib/postgresql
                      name: data
                      subPath: postgresql
            volumes:
                - hostPath:
                    path: /data/gitlab-latest # 修改此行为实际hostPath地址
                  name: data
---
apiVersion: v1
kind: Service
metadata:
    labels:
        name: postgresql
    name: postgresql
    namespace: openpai
spec:
    ports:
        - name: postgres
          port: 5432
          targetPort: postgres
    selector:
        name: postgresql

```

修改redis.yaml文件

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
    labels:
        name: redis
    name: redis
    namespace: openpai # 命名空间
spec:
    selector:
        matchLabels:
            name: redis
    template:
        metadata:
            labels:
                name: redis
            name: redis
        spec:
            containers:
                - image: 192.168.2.56:32002/openpai/redis:6 #镜像地址
                  imagePullPolicy: IfNotPresent
                  livenessProbe:
                    exec:
                        command:
                            - redis-cli
                            - ping
                    initialDelaySeconds: 30
                    timeoutSeconds: 5
                  name: redis
                  ports:
                    - containerPort: 6379
                      name: redis
                  readinessProbe:
                    exec:
                        command:
                            - redis-cli
                            - ping
                    initialDelaySeconds: 30
                    timeoutSeconds: 1
                  volumeMounts:
                    - mountPath: /var/lib/redis
                      name: data
                      subPath: redis
            volumes:
                - hostPath:
                    path: /data//gitlab-latest # 修改此行为实际hostPath地址
                  name: data
---
apiVersion: v1
kind: Service
metadata:
    labels:
        name: redis
    name: redis
    namespace: openpai
spec:
    ports:
        - name: redis
          port: 6379
          targetPort: redis
    selector:
        name: redis

```

‍

‍

‍

Redis部署

上传镜像到镜像仓库

```yaml
docker laod -i redis-xxx-img.tar

docker tag 
```

修改redis.yaml文件

```yaml

```

‍

Nacos部署

```yaml
```

‍

Openpai部署

修改

‍

‍

‍

‍

## 一、文档说明

1. 文档目的：明确OpenPAI 2.0版本的部署流程、配置要求及问题处理标准，助力技术人员高效完成全新部署、升级部署及运维操作。
2. 适用范围：适用于需要部署OpenPAI 2.0的技术实施人员、运维人员，覆盖公共云、专有云等不同环境。
3. 注意事项：部署包链接、账号密码等敏感信息仅限必要人员知晓，禁止发送至公开群组，否则需承担信息泄露责任；部署过程中需确保网络通畅，资源满足最低配置要求。

## 二、部署前期准备

### 1. 资源信息收集

#### （1）账号信息

- 云平台账号：__________（需填写实际账号）
- 密码：__________（需填写实际密码）
- 安全码：联系指定人员（xx）获取

#### （2）镜像资源

- vpc地址：cr.registry.ext.yun.zjtobacco.com
- 命名空间：szhyfyy-dev
- 用户名：__________（需填写实际用户名）
- 密码：__________（需填写实际密码）

#### （3）缓存与数据库资源

|资源类型|vpc地址|公网地址|端口|用户名|密码|备注|
| ----------| -----------------------------------| -------------------------------------| ------| ----------------| ------------| -------------------------|
|MYSQL|pc-xxx.rwlb.rds.aliyuncs.com:5432|pc-xxx-o.rwlb.rds.aliyuncs.com:5432|3306|填写实际用户名|写实际密码|需创建unic-pai、nacos库|

#### （4）对象存储资源（oss）

- endpoint：oss-cn-shanghai.aliyuncs.com
- bucket：__________（需填写实际bucket）
- accessKey：__________（需填写实际aksk）
- accessSecret：__________（需填写实际密码）

#### （5）网络文件存储资源（nas）

- endpoint：1f1dd485b6-e1959.cn-hangzhou-zjtobacco-d01.nas.inner.yun.zjtobacco.com

#### （6）集群资源

##### ack集群

- 节点要求：数据盘≥500G
- 集群token：

```yaml
# 为特定命名空间token分配管理权限
NAMESPACE="openpai"
ROLEBINDING_NAME="openpai-admin"
kubectl create rolebinding $ROLEBINDING_NAME \
  --clusterrole=admin \
  --serviceaccount=$NAMESPACE:default \
  --namespace=$NAMESPACE
# 获取token
kubectl -n $NAMESPACE get secret $(kubectl -n $NAMESPACE get sa default -o jsonpath='{.secrets[0].name}') -o jsonpath='{.data.token}' | base64 -d
```

- ingress信息：SLB InstanceId（lb-xxx）、私网IP（__________）、公网IP（__________）

### 2. 环境依赖检查

#### （1）必备工具（云平台跳过）

- docker
- kubectl：需要可以连接Kubernetes集群

#### （2）权限确认

- 部署机器需具备镜像拉取、推送权限
- 具备k8s集群操作权限（创建pod、service、Deployment等）
- 具备数据库创建、修改权限
- 具备oss、NAS等对象存储读写权限

#### （3）网络配置

- 确保部署机器能访问阿里云ACR、NAS、RDS等服务
- 确保k8s集群内节点间网络互通
- 确保租户侧集群能访问管控侧服务（必要时配置dns或hosts）

## 三、产品部署流程

### 1. 部署工具配置

#### （1）工具下载与解压

- 下载deploy-openpai.tar.gz（制品包中获取）
- 解压命令：`tar -zxvf deploy-tool.tar.gz`
- 解压后目录结构：

  - ​`images`目录：镜像文件存储

    - ​`unic-deploy-img.tar`：微服务镜像
    - ​`nacos-deploy-img.tar`：nacos镜像
    - ​`GtiLab-deploy-img.tar`：GitLab镜像
  - ​`sql`目录：初始化MYSQL数据
  - ​`templates`目录：yaml模板文件
  - ​`dist`目录：渲染后的yaml文件
  - ​`000_Load_And_Push_Images.sh`：加载镜像并上传至镜像仓库
  - ​`001_Init_MySQL.sh`：初始化MYSQL数据
  - ​`002_Generate_deployment_files.sh`：生成部署文件
  - ​`003_Deploy_OpenPAI.sh`：部署到k8s集群
  - ​`update_Image.sh`：更新指定服务镜像
  - ​`global.yaml`：环境配置文件

‍

#### （2）global.yaml配置

- 编辑解压后的global.yaml文件，按现场资源信息更新以下核心配置：

```yaml
acr:
  endpoint: 192.168.2.56:32002  # 替换为实际镜像仓库vpc地址
  username: admin  # 替换为实际镜像仓库用户名
  password: Unicdata@China1  # 替换为实际镜像仓库密码
  namespace: openpai  # 固定值
ack:
  namespace: openpai
oss:
  type: OSS
  endpoint: oss-cn-beijing-internal.aliyuncs.com  # 替换为实际oss vpc endpoint
  publicEndpoint: oss-cn-beijing.aliyuncs.com  # 替换为实际oss公网endpoint
  bucket: sfm-console-dev  # 替换为实际bucket名称
  accessKeyId: xxx  # 替换为实际oss ak
  accessKeySecret: xxx  # 替换为实际oss sk
redis:
  host: r-2zeta1cwcb0kk04ltu.redis.rds.aliyuncs.com  # 替换为实际redis vpc地址
  port: '6379'  # 固定值
  password: xxx  # 替换为实际redis密码
mysql:
  host: ak8s.cn  # 替换为实际redis vpc地址
  port: '13306'  # 固定值
  username: root
  password: Xinyang666!  # 替换为实际redis密码
  unicDatabase: unic-pai  # 固定值
  nacosDatabase: nacos  # 固定值
  ssoDatabase: sso_server  # 固定值
nacos:
  addr: nacos-headless.svc.cluster.local:8848  # 替换为实际nacos vpc地址
  namespace: prod  # 固定值
  group: openpai  # 固定值
  password: Unicdata@1qaz  # 固定值
opentrekDomain: sfm.aliyun.com  # 替换为实际对外域名
systemToken: xJS3jfCyEjnHKwEaMT84DhGhDFb3EMrF  # 替换为32位随机字符串
deploy:
  enabled: false  # 未部署sfm-tianyan组件时为false
data:
  hostpath: /data/ # 替换为实际数据目录

openpai:
  gateway:
    image: pai-b-gateway:latest
  model:
    image: pai-b-model:latest
  sso:
    image: pai-b-sso:latest
  api:
    image: pai-b-api:latest
  app:
    image: pai-b-app:latest
  dataset:
    image: pai-b-data:latest
  pai-f-2024:
    image: pai-b-data:latest
```

### 3. 执行部署命令

#### 3.1 部署指令

‍

##### 1. 加载镜像并推送至远端仓库

方式一：

```yaml
bash 000_Load_And_Push_Images.sh

image: xxxx Load successfull
image: xxxx Push successfull

image: yyy Load successfull
image: yyy Push successfull
```

方式二：

```yaml
根据实际情况上传tar包到对应仓库
```

##### 2. 初始化数据库

方式一：

```yaml
bash 002_init_sql.sh
import unic-pai database  successufull
import sso_server database  successufull
import nacos database  successufull
```

方式二：

```yaml
根基实际情况将当前目录下的sql/xxx.sql分别导入对应数据库
```

‍

##### 3. 解析global.yaml，生成部署文件

```yaml
bash 003_Generate_deployment_files.sh
pai-f server Generate successufull
sso server Generate successufull
dataset server Generate successufull
gateway server Generate successufull
api server Generate successufull
app server Generate successufull
model server Generate successufull
```

##### 4. 检查文件信息是否正确

```yaml
DIR/dist/ 下为根据global.yaml渲染后的部署文件
```

##### 5. 部署

```yaml
bash 004_Deploy_OpenPAI.sh
```

手动部署可以单独`apply dist目录下的文件`如下：

```yaml

kubectl apply -f dist/nacos/nacos.yaml
```

‍

### 4. License安装与配置

将license 文件放到 /cpfs/license（global.yaml文件中的hostpath）目录

## 四、升级部署说明

### 1. 升级前期准备

- 下载对应版本的镜像deploy-tool.tar
- 将镜像文章放到部署目录`images/`下

### 2. 升级

加载镜像到集群

```yaml
update_Image.sh images/unic-pai-img.tar 
```

​`--file:` 指定镜像tar文件

‍

## 五、高级配置指南

### 1. 调度到服务到指定节点

修改部署文件中的`template`​下的`yaml`，增加如下内容

```yaml
spec:
  template:
    spec:
      nodeSelector:
        kubernetes.io/hostname: work1
```

‍
